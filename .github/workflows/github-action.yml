name: Deploy Laravel to VPS

on:
  push:
    branches:
      - "deployment"   # ganti sesuai branch deploy

jobs:
  deploy:
    name: CI/CD to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            REPO="https://${{ secrets.GIT_TOKEN }}@github.com/RohmaRifqiPamungkas/Shorten-Link.git"
            DIR="${{ secrets.VPS_PATH }}"   # contoh: /home/docker/laravel_docker
            CONTAINER="laravel_app"
            BRANCH="deployment"

            echo "=== Pastikan git & docker tersedia ==="
            if ! command -v git &>/dev/null; then
              sudo apt-get update && sudo apt-get install -y git
            fi
            if ! command -v docker &>/dev/null; then
              curl -fsSL https://get.docker.com | sh
              sudo usermod -aG docker $USER
            fi
            if ! docker compose version &>/dev/null; then
              mkdir -p ~/.docker/cli-plugins
              curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 \
                -o ~/.docker/cli-plugins/docker-compose
              chmod +x ~/.docker/cli-plugins/docker-compose
            fi

            echo "=== Fix permission repo sebelum git pull ==="
            sudo mkdir -p $DIR
            sudo chown -R $USER:$USER $DIR

            echo "=== Clone atau pull repo ==="
            if [ ! -d "$DIR/.git" ]; then
              rm -rf $DIR
              git clone --branch $BRANCH $REPO $DIR
            else
              cd $DIR
              git fetch origin $BRANCH
              git reset --hard origin/$BRANCH
            fi

            echo "=== Debug isi repo ==="
            ls -lah $DIR | head -n 20
            [ -f "$DIR/composer.json" ] || { echo "❌ composer.json tidak ada di host"; exit 1; }
            [ -f "$DIR/docker-compose.yml" ] || { echo "❌ docker-compose.yml tidak ada"; exit 1; }

            echo "=== Simpan .env Laravel ==="
            echo "${{ secrets.LARAVEL_ENV }}" > $DIR/.env

            echo "=== Buat .env.deploy untuk Docker Compose ==="
            cat > "$DIR/.env.deploy" <<EOL
            APP_PORT=${{ secrets.APP_PORT }}
            DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            EOL

            echo "=== Restart Docker Compose ==="
            cd $DIR
            docker compose down || true
            docker compose --env-file .env.deploy up -d --build

            echo "=== Cek isi container ==="
            sleep 5
            docker exec $CONTAINER ls -lah /var/www/html || { echo "❌ Gagal akses /var/www/html"; exit 1; }
            docker exec $CONTAINER test -f /var/www/html/composer.json || { echo "❌ composer.json tidak ada di container!"; exit 1; }

            echo "=== Fix git ownership dalam container ==="
            docker exec $CONTAINER git config --global --add safe.directory /var/www/html

            echo "=== Pastikan Laravel siap (max 10x percobaan) ==="
            for i in {1..10}; do
              if docker exec $CONTAINER php artisan --version > /dev/null 2>&1; then
                echo "✅ Laravel siap pada percobaan $i!"
                break
              else
                echo "⏳ Menunggu Laravel container... percobaan $i"
                sleep 5
              fi
              [ $i -eq 10 ] && { echo "❌ Laravel tidak siap"; docker logs $CONTAINER; exit 1; }
            done

            echo "=== Jalankan Composer & Artisan ==="
            docker exec $CONTAINER composer install --optimize-autoloader --no-dev
            docker exec $CONTAINER php artisan key:generate
            docker exec $CONTAINER php artisan migrate --force

            echo "=============================================="
            echo "✅ Deployment Laravel ke VPS selesai sukses!"
            echo "=============================================="
